{% extends "base.html" %}

{% block title %}Nutrition Suggestions - MedVault{% endblock %}

{% block content %}
<div class="nutrition-page">
    <div class="page-header">
        <h1>
            <img src="{{ url_for('static', filename='nutrition-icon.svg') }}" alt="Nutrition" class="page-icon"> 
            Nutrition Suggestions
        </h1>
        <p>Search for nutrition information and track your food intake</p>
    </div>

    <!-- Mode Toggle Section -->
    <div class="mode-toggle-section">
        <div class="toggle-container">
            <label class="toggle-label">
                <span class="toggle-text">Data Source:</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="api-mode-toggle" class="toggle-input">
                    <span class="toggle-slider"></span>
                </div>
                <span class="toggle-text" id="mode-text">Local Data</span>
            </label>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="section-header">
            <h2>Search Food Nutrition</h2>
        </div>
        
        <form id="nutrition-search-form" class="search-form">
            <div class="search-input-group">
                <input type="text" id="food-search" placeholder="e.g., 2 chapatis and dal, 1 cup rice" required>
                <button type="submit" class="btn btn-primary">
                    <img src="{{ url_for('static', filename='search-icon.svg') }}" alt="Search" class="btn-icon"> 
                    Search
                </button>
            </div>
        </form>

        <!-- Loading indicator -->
        <div id="loading-indicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Searching nutrition data...</span>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="results-section" style="display: none;">
            <h3>Nutrition Results</h3>
            <div id="results-container" class="results-grid">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="error-message" style="display: none;">
            <!-- Error messages will be shown here -->
        </div>
    </div>

    <!-- Nutrition History Section -->
    <div class="history-section">
        <div class="section-header">
            <h2>My Nutrition History</h2>
            <button id="refresh-history" class="btn btn-secondary">
                <img src="{{ url_for('static', filename='refresh-icon.svg') }}" alt="Refresh" class="btn-icon"> 
                Refresh
            </button>
        </div>

        <!-- History Loading -->
        <div id="history-loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Loading history...</span>
        </div>

        <!-- History Content -->
        <div id="history-content" class="history-content">
            <div id="history-empty" class="empty-state" style="display: none;">
                <img src="{{ url_for('static', filename='nutrition-icon.svg') }}" alt="No History" class="empty-icon">
                <h3>No Nutrition History</h3>
                <p>Start searching for foods to build your nutrition history!</p>
            </div>
            
            <div id="history-list" class="history-list">
                <!-- History items will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Toast -->
<div id="toast" class="toast" style="display: none;">
    <span id="toast-message"></span>
</div>

<script>
// Nutrition page JavaScript functionality
document.addEventListener('DOMContentLoaded', function() {
    const apiModeToggle = document.getElementById('api-mode-toggle');
    const modeText = document.getElementById('mode-text');
    const searchForm = document.getElementById('nutrition-search-form');
    const foodSearch = document.getElementById('food-search');
    const loadingIndicator = document.getElementById('loading-indicator');
    const searchResults = document.getElementById('search-results');
    const resultsContainer = document.getElementById('results-container');
    const errorMessage = document.getElementById('error-message');
    const historyContent = document.getElementById('history-content');
    const historyList = document.getElementById('history-list');
    const historyEmpty = document.getElementById('history-empty');
    const historyLoading = document.getElementById('history-loading');
    const refreshHistoryBtn = document.getElementById('refresh-history');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    // Toggle between API and Local data mode
    apiModeToggle.addEventListener('change', function() {
        if (this.checked) {
            modeText.textContent = 'API Mode';
        } else {
            modeText.textContent = 'Local Data';
        }
    });

    // Search form submission
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        searchNutrition();
    });

    // Refresh history button
    refreshHistoryBtn.addEventListener('click', function() {
        loadNutritionHistory();
    });

    // Search nutrition function
    async function searchNutrition() {
        const query = foodSearch.value.trim();
        if (!query) return;

        // Show loading, hide results and errors
        loadingIndicator.style.display = 'flex';
        searchResults.style.display = 'none';
        errorMessage.style.display = 'none';

        try {
            const response = await fetch('/nutrition/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    food: query,
                    use_api: apiModeToggle.checked
                })
            });

            const data = await response.json();

            if (response.ok) {
                displayResults(data.results);
            } else {
                showError(data.error || 'Search failed');
            }
        } catch (error) {
            showError('Network error occurred');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // Display search results
    function displayResults(results) {
        resultsContainer.innerHTML = '';
        
        results.forEach(result => {
            const resultCard = createResultCard(result);
            resultsContainer.appendChild(resultCard);
        });

        searchResults.style.display = 'block';
    }

    // Create result card
    function createResultCard(nutrition) {
        const card = document.createElement('div');
        card.className = 'nutrition-card';
        
        card.innerHTML = `
            <div class="card-header">
                <h4>${nutrition.name}</h4>
            </div>
            <div class="card-body">
                <div class="nutrition-info">
                    <div class="nutrition-item">
                        <span class="label">Calories:</span>
                        <span class="value">${nutrition.calories}</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="label">Protein:</span>
                        <span class="value">${nutrition.protein}g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="label">Carbs:</span>
                        <span class="value">${nutrition.carbs}g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="label">Fat:</span>
                        <span class="value">${nutrition.fat}g</span>
                    </div>
                </div>
                <button class="btn btn-primary save-btn" onclick="saveNutrition('${nutrition.name}', ${nutrition.calories}, ${nutrition.protein}, ${nutrition.carbs}, ${nutrition.fat})">
                    <img src="{{ url_for('static', filename='plus-icon.svg') }}" alt="Save" class="btn-icon"> 
                    Save to History
                </button>
            </div>
        `;
        
        return card;
    }

    // Save nutrition to history
    window.saveNutrition = async function(name, calories, protein, carbs, fat) {
        try {
            const response = await fetch('/nutrition/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    food_name: name,
                    calories: calories,
                    protein: protein,
                    carbs: carbs,
                    fat: fat
                })
            });

            const data = await response.json();

            if (response.ok) {
                showToast('Nutrition data saved successfully!', 'success');
                loadNutritionHistory(); // Refresh history
            } else {
                showToast(data.error || 'Failed to save nutrition data', 'error');
            }
        } catch (error) {
            showToast('Network error occurred', 'error');
        }
    };

    // Load nutrition history
    async function loadNutritionHistory() {
        historyLoading.style.display = 'flex';
        historyList.style.display = 'none';
        historyEmpty.style.display = 'none';

        try {
            const response = await fetch('/nutrition/history');
            const data = await response.json();

            if (response.ok) {
                displayHistory(data.history);
            } else {
                showError('Failed to load history');
            }
        } catch (error) {
            showError('Network error occurred');
        } finally {
            historyLoading.style.display = 'none';
        }
    }

    // Display nutrition history
    function displayHistory(history) {
        if (history.length === 0) {
            historyEmpty.style.display = 'block';
            historyList.style.display = 'none';
            return;
        }

        historyList.innerHTML = '';
        
        history.forEach(item => {
            const historyItem = createHistoryItem(item);
            historyList.appendChild(historyItem);
        });

        historyList.style.display = 'block';
        historyEmpty.style.display = 'none';
    }

    // Create history item
    function createHistoryItem(item) {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        const date = new Date(item.created_at).toLocaleDateString();
        
        historyItem.innerHTML = `
            <div class="history-content">
                <div class="history-header">
                    <h4>${item.food_name}</h4>
                    <span class="history-date">${date}</span>
                </div>
                <div class="history-nutrition">
                    <span class="nutrition-badge">Calories: ${item.calories}</span>
                    <span class="nutrition-badge">Protein: ${item.protein}g</span>
                    <span class="nutrition-badge">Carbs: ${item.carbs}g</span>
                    <span class="nutrition-badge">Fat: ${item.fat}g</span>
                </div>
            </div>
            <button class="btn btn-danger delete-btn" onclick="deleteHistoryItem(${item.id})">
                <img src="{{ url_for('static', filename='delete-icon.svg') }}" alt="Delete" class="btn-icon"> 
                Delete
            </button>
        `;
        
        return historyItem;
    }

    // Delete history item
    window.deleteHistoryItem = async function(id) {
        if (!confirm('Are you sure you want to delete this nutrition record?')) {
            return;
        }

        try {
            const response = await fetch(`/nutrition/history/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                showToast('Nutrition record deleted successfully!', 'success');
                loadNutritionHistory(); // Refresh history
            } else {
                showToast(data.error || 'Failed to delete nutrition record', 'error');
            }
        } catch (error) {
            showToast('Network error occurred', 'error');
        }
    };

    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        searchResults.style.display = 'none';
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        toastMessage.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // Load history on page load
    loadNutritionHistory();
});
</script>
{% endblock %}